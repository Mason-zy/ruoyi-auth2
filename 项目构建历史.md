# 项目构建历史

## 功能添加

### 2024-07-04 添加BladeX认证集成功能

添加了与BladeX系统的简单认证集成，包括：

1. 创建了BladeAuthUtil工具类，用于与BladeX认证服务交互
2. 创建了BladeAuthController控制器，处理BladeX认证回调
3. 在application.yml中添加了BladeX认证相关配置

集成使用了轻量级设计，采用Map而非实体类接收认证响应，减少了不必要的复杂度。整个认证流程如下：

1. 用户点击"使用BladeX登录"按钮跳转到BladeX授权页
2. 用户在BladeX系统完成授权后重定向回应用
3. 应用使用授权码调用BladeX认证服务获取token
4. 前端保存token并在后续请求中使用

### 2024-07-05 实现BladeX与若依原生登录流程集成

使用与若依原生登录一致的方式处理BladeX认证用户：

1. 通过授权码获取BladeX令牌和用户信息
2. 根据返回的用户名在若依系统中查找用户
3. 找到用户后完全按照若依原生流程构建登录令牌：
   - 使用UserDetailsServiceImpl创建LoginUser对象
   - 记录登录IP和时间
   - 使用TokenService生成JWT令牌
   - 将令牌缓存到Redis
4. 前端接收若依令牌并进行登录

优势：
- 完全复用了若依原生登录流程后半部分
- 令牌格式、存储、过期机制与原生系统保持一致
- 最小化修改，降低集成风险
- BladeX用户享有与普通登录用户相同的体验

### 2024-07-05 实现BladeX令牌管理

实现了完整的BladeX令牌管理机制，支持以下功能：

1. 将用户的BladeX令牌与若依用户ID绑定存储在Redis中
2. 提供令牌管理器BladeTokenManager，负责令牌的存储、获取和删除
3. 实现BladeX API调用客户端，支持使用用户令牌调用BladeX API
4. 在用户登录成功时自动保存BladeX令牌
5. 提供测试接口，用于验证令牌状态和调用BladeX API

主要组件：
- BladeToken：存储用户的BladeX令牌信息
- BladeTokenManager：管理令牌的存储、获取和删除
- BladeApiClient：用于调用BladeX API的客户端
- BladeApiController：提供BladeX API调用相关接口

整个令牌管理流程如下：
1. 用户通过BladeX认证并获取授权码
2. 授权码传递到后端，获取BladeX访问令牌
3. 用户在若依系统中成功登录后，将BladeX令牌与用户ID绑定存储在Redis
4. 调用BladeX API时，从Redis获取对应用户的令牌并添加到请求头
5. 令牌过期时，通过接口通知用户重新登录

这种设计保证了每个用户的BladeX令牌互相隔离，并且与用户会话生命周期保持一致。当令牌过期或用户登出时，相应的BladeX令牌也会被清除。

## 问题修复

### 2024-07-04 修复BladeX认证接口访问权限问题

#### 问题描述
BladeX认证回调接口需要登录才能访问，导致单点登录流程中断，前端接收到JWT格式错误的提示。

#### 问题原因
在Spring Security的配置中，BladeX认证回调接口`/blade/auth/callback`没有被添加到匿名访问白名单中，导致未登录用户无法访问该接口。

#### 解决方案
在`SecurityConfig.java`中将`/blade/auth/callback`接口添加到匿名访问白名单中，允许未登录用户访问认证回调接口：
```java
.antMatchers("/blade/auth/callback").permitAll()
```

### 2024-07-04 调整BladeX接口命名与路径

#### 问题描述
前端回调路径和后端接口路径不匹配，接口命名不合理，导致授权失败。

#### 问题原因
后端接口命名为`/blade/auth/callback`，而实际功能是获取BladeX用户令牌信息，与前端回调路径`/auth/blade-callback`容易混淆。前者是API接口，后者是页面URL。

#### 解决方案
1. 将后端接口路径从`/blade/auth/callback`改为`/blade/auth/getTokenInfo`，更准确地反映其功能
2. 修改前端调用接口的URL路径，确保与后端匹配
3. 更新安全配置，允许新的API路径匿名访问

这样明确区分了：
- 前端回调页面路径：`/auth/blade-callback`（BladeX重定向到若依的页面URL）
- 后端API接口路径：`/blade/auth/getTokenInfo`（获取BladeX用户令牌的接口）

### 2024-07-04 添加BladeX认证配置项和调试日志

#### 问题描述
BladeX认证服务配置项未填充实际值，导致认证失败，前端显示"未配置BladeX认证服务"错误。

#### 问题原因
在application.yml文件中，虽然添加了BladeX认证的配置结构，但未填入实际的认证服务地址、客户端ID、密钥和回调URI等参数。

#### 解决方案
1. 根据前端环境变量(.env.development)中的配置，填充application.yml中的BladeX认证配置项：
```yaml
blade:
  auth:
    url: https://auth.we-safer.net/oauth/token
    client-id: chem_ruoyi
    client-secret: chem_ruoyi_secret
    redirect-uri: http://192.168.100.106:81/auth/blade-callback
```

2. 添加更多的日志输出，帮助排查认证过程中的问题：
   - 在BladeAuthUtil中添加详细的请求参数和响应日志
   - 在BladeAuthController中增加配置项检查和请求处理日志
   - 在前端BladeCallback.vue中添加控制台调试日志

这些改进有助于跟踪整个认证流程，快速定位问题所在。

### 2024-07-05 修复前端处理BladeX认证响应的问题

#### 问题描述
前端在接收BladeX认证响应时出现错误：`Cannot read properties of undefined (reading 'token')`，导致无法完成单点登录流程。

#### 问题原因
前端在访问`response.data.token`前没有检查`response.data`是否存在，同时没有考虑token可能直接存在于response对象中的情况，导致在解析响应数据时出现错误。

#### 解决方案
1. 在BladeCallback.vue中添加详细的调试日志，输出响应数据结构
2. 添加对`response.data`存在性的检查，防止访问undefined属性
3. 增加对直接存在于`response`中的token的支持
4. 在`handleLoginSuccess`方法中添加日志，跟踪token传递过程

修改后的代码更健壮，能够处理多种响应数据结构，确保在任何情况下都能正确提取token。